# ChatGPT-like Chat Interface Documentation

## Overview

The Kronos Chat interface provides a modern, ChatGPT-like conversational experience with real-time streaming responses. It's built using React with TypeScript and integrates seamlessly with the Gemini AI backend through custom streaming endpoints.

## Features

### ðŸŽ¯ Core Chat Features
- **Real-time Streaming**: Messages stream in real-time as they're generated by the AI
- **Conversation History**: Maintains context across multiple messages in a conversation
- **Message Persistence**: Conversations persist during the session
- **Auto-scroll**: Automatically scrolls to new messages
- **Responsive Design**: Works on desktop, tablet, and mobile devices

### ðŸ’¬ User Interface Features
- **ChatGPT-like Layout**: Familiar chat bubble interface with user and assistant messages
- **Auto-resizing Input**: Text area automatically expands as you type
- **Keyboard Shortcuts**: Enter to send, Shift+Enter for new lines
- **Loading States**: Visual indicators for streaming and processing states
- **Error Handling**: Graceful error display and recovery

### ðŸ”§ Advanced Features
- **Stream Control**: Stop streaming responses mid-generation
- **Conversation Management**: Clear conversations and start fresh
- **Timestamps**: Message timestamps for conversation tracking
- **Multi-line Input**: Support for complex, multi-line prompts

## Architecture

### Backend Implementation

#### Streaming Endpoints (`/server/app/api/v1/endpoints/chat.py`)

**Key Endpoints:**
- `POST /api/v1/chat/message` - Send single message (non-streaming)
- `POST /api/v1/chat/stream` - Stream chat responses in real-time
- `POST /api/v1/chat/conversation` - Continue multi-turn conversations

**Streaming Protocol:**
```
POST /api/v1/chat/stream
Content-Type: application/json
Authorization: Bearer <jwt_token>

{
  "message": "Hello, how are you?",
  "conversation_history": [...previous messages...],
  "conversation_id": "conv_user123_abc123",
  "system_prompt": "You are Kronos, a helpful AI assistant."
}
```

**Streaming Response Format:**
```
data: {"type": "conversation_id", "data": "conv_user123_abc123"}

data: {"type": "content", "data": "Hello! I'm", "conversation_id": "conv_user123_abc123", "timestamp": "2024-01-15T10:30:00Z"}

data: {"type": "content", "data": " doing well, thank you", "conversation_id": "conv_user123_abc123", "timestamp": "2024-01-15T10:30:01Z"}

data: {"type": "done", "conversation_id": "conv_user123_abc123", "timestamp": "2024-01-15T10:30:02Z"}
```

#### Gemini Integration
- Uses Google Gemini AI for text generation
- Supports streaming responses through `generate_text_stream()`
- Handles conversation context and system prompts
- Implements proper error handling and timeout management

### Frontend Implementation

#### Main Component (`/client/src/components/ChatInterface.tsx`)

**Key Features:**
- **React Hooks**: Uses `useState`, `useRef`, `useEffect`, and `useCallback`
- **Stream Processing**: Handles Server-Sent Events (SSE) for real-time streaming
- **State Management**: Manages messages, input, streaming status, and errors
- **Auto-scroll**: Automatically scrolls to new messages using refs

**Component Structure:**
```tsx
interface ChatInterfaceProps {
  userId?: string;
}

interface StreamChunk {
  type: 'conversation_id' | 'content' | 'done' | 'error';
  data?: string;
  conversation_id?: string;
  timestamp?: string;
  error?: string;
}
```

#### API Integration (`/client/src/services/apiService.ts`)

**New Methods:**
- `sendChatMessage()` - Send single message
- `streamChatMessage()` - Initiate streaming chat

**Streaming Implementation:**
```typescript
async streamChatMessage(request: StreamChatRequest): Promise<ReadableStream> {
  const response = await fetch(`${this.client.defaults.baseURL}/chat/stream`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
    },
    body: JSON.stringify(request),
  });

  return response.body;
}
```

## User Experience

### Chat Flow
1. **User Input**: Type message in the auto-resizing textarea
2. **Send Message**: Press Enter or click Send button
3. **Streaming Response**: AI response streams in real-time with typing indicator
4. **Conversation Context**: Previous messages provide context for follow-up questions
5. **Management**: Clear conversation or stop streaming as needed

### Visual Design
- **User Messages**: Blue bubbles aligned to the right
- **AI Messages**: Gray bubbles aligned to the left with border
- **Streaming Indicator**: Blinking cursor shows active streaming
- **Loading States**: Animated dots for initial processing
- **Error States**: Red-bordered error messages with clear descriptions

### Responsive Layout
- **Desktop**: Full-width chat interface with optimal spacing
- **Tablet**: Adjusted spacing and touch-friendly controls
- **Mobile**: Condensed layout with optimized input area

## Usage Examples

### Basic Chat
```typescript
// Send a simple message
const response = await apiService.sendChatMessage({
  message: "What is the weather like today?",
  system_prompt: "You are a helpful assistant."
});
```

### Streaming Chat
```typescript
// Start streaming conversation
const stream = await apiService.streamChatMessage({
  message: "Tell me a story",
  conversation_history: previousMessages,
  conversation_id: currentConversationId
});

const reader = stream.getReader();
const decoder = new TextDecoder();

while (true) {
  const { done, value } = await reader.read();
  if (done) break;
  
  const chunk = decoder.decode(value, { stream: true });
  // Process streaming chunks...
}
```

### Conversation Management
```typescript
// Clear conversation
const clearConversation = () => {
  setMessages([]);
  setCurrentConversationId('');
  setStreamingMessage('');
  setError(null);
};

// Stop streaming
const handleStopStreaming = () => {
  if (abortControllerRef.current) {
    abortControllerRef.current.abort();
    setIsStreaming(false);
  }
};
```

## Configuration

### Environment Variables
```env
# Backend
GEMINI_API_KEY=your_gemini_api_key_here
GEMINI_MODEL=gemini-1.5-flash-latest
GEMINI_TEMPERATURE=0.7
GEMINI_MAX_TOKENS=2000

# Frontend
VITE_API_BASE_URL=http://localhost:8000/api/v1
```

### System Prompts
The default system prompt can be customized:
```
"You are Kronos, a helpful AI assistant. You are knowledgeable, friendly, and provide clear, concise responses."
```

## Security Features

- **JWT Authentication**: All chat endpoints require valid authentication
- **User Isolation**: Users can only access their own conversations
- **Input Validation**: Message content is validated before processing
- **Rate Limiting**: Built-in protections against abuse
- **CORS Configuration**: Proper cross-origin request handling

## Performance Optimizations

- **Streaming**: Real-time response streaming for better perceived performance
- **Auto-scroll**: Efficient scrolling using refs instead of DOM queries
- **Debounced Auto-resize**: Optimized textarea resizing
- **Memory Management**: Proper cleanup of streams and abort controllers
- **Lazy Loading**: Messages are rendered efficiently

## Error Handling

### Common Errors
1. **Network Issues**: Automatic retry and clear error messages
2. **Authentication Failures**: Redirect to login when tokens expire
3. **Streaming Interruption**: Graceful handling of connection drops
4. **AI Service Unavailable**: Clear messaging when Gemini is down

### Error Recovery
- **Retry Mechanisms**: Automatic retry for transient failures
- **Graceful Degradation**: Fallback to non-streaming mode if needed
- **User Feedback**: Clear error messages with suggested actions
- **State Recovery**: Maintain conversation state during errors

## Browser Compatibility

- **Modern Browsers**: Chrome 80+, Firefox 80+, Safari 14+, Edge 80+
- **Required Features**: Fetch API, ReadableStream, AbortController
- **Polyfills**: Included for older browser support
- **Mobile Support**: iOS Safari 14+, Chrome Mobile 80+

## Future Enhancements

- **Message Persistence**: Save conversations to database
- **Conversation Sharing**: Share interesting conversations
- **Message Editing**: Edit and regenerate responses
- **Export Functionality**: Export conversations as text/PDF
- **Voice Input**: Speech-to-text integration
- **File Uploads**: Support for image and document uploads
- **Custom Themes**: Dark mode and custom styling options
- **Conversation Search**: Search through message history

## Troubleshooting

### Common Issues

1. **Streaming Not Working**
   - Check network connectivity
   - Verify Gemini API key configuration
   - Ensure browser supports streaming

2. **Messages Not Appearing**
   - Check authentication status
   - Verify API endpoint configuration
   - Check browser console for errors

3. **Auto-scroll Issues**
   - Browser may be blocking smooth scrolling
   - Check CSS overflow settings
   - Verify ref assignments

### Debug Information
- Browser DevTools Network tab shows streaming requests
- Console logs provide detailed error information
- API responses include helpful error messages
- Stream chunks can be logged for debugging

## API Reference

### Chat Message Types
```typescript
interface ChatMessage {
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp?: string;
}
```

### Request/Response Types
```typescript
interface StreamChatRequest {
  message: string;
  conversation_history?: ChatMessage[];
  conversation_id?: string;
  system_prompt?: string;
  temperature?: number;
  max_tokens?: number;
}

interface ChatResponse {
  message: string;
  conversation_id: string;
  timestamp: string;
}
```

The chat interface is now fully functional and provides a modern, streaming-enabled conversational experience that rivals ChatGPT in terms of user experience and functionality!
